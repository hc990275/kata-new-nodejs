# 🚀 Kata-Node 项目详解与使用指南

本项目是一个专为 Node.js 环境（如各类 PaaS 平台或 Linux 服务器）设计的轻量级、抗检测网络服务部署工具。它能够自动配置并运行 Sing-box 内核，提供 Tuic 和 Vless (Reality) 协议支持。

## ✨ 核心特性

* **隐蔽性强**：
* 进程与文件名伪装成普通 Web 服务 (`index.js`, `package.json`)。
* 使用 `Reality` 协议和自签名证书伪装 TLS 流量。


* **极简部署**：
* 支持“一行命令”安装。
* 支持 Node.js 环境下的自动引导启动（通过 `index.js` 自动处理端口并拉取脚本）。


* **轻量化**：
* 针对 128MB+ 内存环境优化。
* 移除冗余组件（如哪吒监控、Argo 隧道），仅保留核心代理功能。


* **自动化运维**：
* **自动重启**：内置守护进程，每天凌晨 00:03 (服务器时间) 自动重启服务以释放内存。
* **自动配置**：自动生成 UUID、证书密钥和 Sing-box 配置文件。



---

## 🛠️ 部署方式

### 方式一：Linux 服务器 / 终端一键脚本

适用于拥有 SSH 访问权限的 VPS。直接在终端执行以下命令：

```bash
bash <(curl -sL https://raw.githubusercontent.com/hc990275/kata-nodejs/main/install.sh)

```

**脚本执行流程：**

1. 交互式询问服务端口。
2. 自动下载 Sing-box 内核。
3. 生成配置文件并启动服务。
4. 输出节点连接链接。

### 方式二：PaaS 平台 / Node.js 环境部署

适用于 Heroku、Render 等仅提供 Node.js 运行环境的平台。

1. **上传文件**：将仓库中的 `index.js` 上传至项目根目录。
2. **启动命令**：设置启动命令为 `node index.js`。

**`index.js` 的工作原理：**

* **端口探测**：自动获取环境变量 `SERVER_PORT` / `PORT`，若未定义则随机生成一个 10000-65000 之间的端口。
* **自动安装**：它会构造命令，将端口号通过管道传递给 `install.sh`，从而实现非交互式的自动化安装与启动。

---

## ⚙️ 技术细节与配置说明

### 1. 协议配置

脚本运行后会生成 `config.json`，包含以下入站协议：

* **Tuic** (基于 QUIC):
* 端口：与输入端口一致
* 拥塞控制：BBR
* ALPN: `h3`


* **Vless + Reality**:
* 端口：与输入端口一致
* 流控：`xtls-rprx-vision`
* SNI (伪装域名): `www.nazhumi.com`
* 目标服务：转发至 `www.nazhumi.com:443`



### 2. 文件结构变化

安装脚本执行后，会在运行目录（通常是 `.npm` 目录）下生成以下核心文件：

| 文件名 | 用途 |
| --- | --- |
| `start.sh` | 核心启动脚本，包含环境变量设置、证书生成、守护进程逻辑。 |
| `config.json` | Sing-box 的运行配置文件。 |
| `uuid.txt` | 存储生成的唯一用户 ID (UUID)。 |
| `list.txt` | 包含生成的节点连接链接 (URL Scheme)。 |
| `sub.txt` | `list.txt` 的 Base64 编码版本，可作为订阅地址使用。 |
| `cert.pem` / `key.txt` | 自动生成的自签名证书或 Reality 密钥对。 |

### 3. 守护进程逻辑

`start.sh` 包含一个无限循环，监控时间：

* **检测逻辑**：每 30 秒检查一次时间。
* **重启触发**：当服务器时间为 **00:03** 时，自动 Kill 掉当前 Sing-box 进程并重新启动。
* **目的**：防止长时间运行导致的内存泄漏或被云平台强制回收。

---

## 📝 常见问题与注意事项

1. **内存要求**：
* 虽然脚本提及不建议 64M 内存环境使用，但在 128M 及以上环境表现良好。
* 如果遇到 OOM (内存溢出) 崩溃，请检查是否开启了其他占用内存的进程。


2. **端口已被占用**：
* 如果脚本提示端口占用，请在安装时更换一个端口，或检查是否已有其他服务占用了该 TCP/UDP 端口。


3. **连接失败**：
* 请确保服务器防火墙（如 AWS Security Group, 阿里云安全组）已放行您设置的 **TCP 和 UDP** 端口。Tuic 协议主要依赖 UDP。


4. **关于 `index.js` 的报错**：
* 在自动安装模式下，控制台可能会显示 `安装脚本执行结束或接管了进程`，或者看似报错退出。只要后续日志显示 Sing-box Running 或输出了节点链接，即可忽略该提示。



---

## 📜 许可证

本项目基于 [MIT License](https://www.google.com/search?q=LICENSE) 开源。您可以免费使用、修改和分发，但需保留版权声明，且作者不对使用后果负责。
